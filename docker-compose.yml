# ==============================================
# DOCKER COMPOSE - CRM PROTECAR
# ==============================================
# Orquestração completa do sistema:
# - MySQL 8.0
# - Backend (Node.js/Express/TypeScript)
# - Frontend (Next.js)
#
# Para iniciar: docker-compose up -d
# Para parar: docker-compose down
# Ver logs: docker-compose logs -f

version: '3.8'

services:
  # ==============================================
  # BANCO DE DADOS MYSQL 8.0
  # ==============================================
  mysql:
    image: mysql:8.0
    container_name: protecar-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-protecar_dev_2025}
      MYSQL_DATABASE: ${DB_NAME:-protecar_crm}
      MYSQL_USER: ${DB_USER:-protecar_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-protecar_dev_2025}
      # Configurações de performance
      MYSQL_INNODB_BUFFER_POOL_SIZE: 256M
      MYSQL_MAX_CONNECTIONS: 100
    ports:
      - "${DB_PORT:-3306}:3306"
    volumes:
      # Persistência de dados
      - mysql_data:/var/lib/mysql
      # Configuração customizada
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      # Migrations (para fácil execução)
      - ./backend/migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - protecar-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pprotecar_dev_2025"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command: 
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password

  # ==============================================
  # BACKEND API (NODE.JS + EXPRESS)
  # ==============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: ${NODE_ENV:-development}
    container_name: protecar-backend
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-3001}
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: ${DB_NAME:-protecar_crm}
      DB_USER: ${DB_USER:-protecar_user}
      DB_PASSWORD: ${DB_PASSWORD:-protecar_dev_2025}
      JWT_SECRET: ${JWT_SECRET:-dev_secret_key_not_for_production_12345678}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    ports:
      - "${PORT:-3001}:3001"
    volumes:
      # Em desenvolvimento: hot reload
      - ./backend/src:/app/src:ro
      - ./backend/uploads:/app/uploads
      # Node modules (não sobrescrever)
      - backend_node_modules:/app/node_modules
    networks:
      - protecar-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==============================================
  # FRONTEND (NEXT.JS)
  # ==============================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      target: ${NODE_ENV:-development}
    container_name: protecar-frontend
    restart: unless-stopped
    depends_on:
      - backend
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3001}
    ports:
      - "3000:3000"
    volumes:
      # Em desenvolvimento: hot reload
      - ./app:/app/app:ro
      - ./components:/app/components:ro
      - ./lib:/app/lib:ro
      - ./store:/app/store:ro
      - ./hooks:/app/hooks:ro
      - ./types:/app/types:ro
      - ./public:/app/public:ro
      # Node modules (não sobrescrever)
      - frontend_node_modules:/app/node_modules
      - ./.next:/app/.next
    networks:
      - protecar-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# ==============================================
# VOLUMES PERSISTENTES
# ==============================================
volumes:
  mysql_data:
    driver: local
    name: protecar_mysql_data
  backend_node_modules:
    driver: local
    name: protecar_backend_node_modules
  frontend_node_modules:
    driver: local
    name: protecar_frontend_node_modules

# ==============================================
# REDE INTERNA
# ==============================================
networks:
  protecar-network:
    driver: bridge
    name: protecar-network
